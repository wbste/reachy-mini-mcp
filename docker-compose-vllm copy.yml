services:
  cleanup:
    image: alpine:latest
    container_name: system-cleanup
    privileged: true
    command: sh -c "sync && echo 3 > /proc/sys/vm/drop_caches && echo 'Cache cleanup completed'"
    volumes:
      - /proc:/proc
    
  vllm-server:
    env_file:
      - .env
    image: nvcr.io/nvidia/vllm:25.10-py3
    container_name: vllm-llama-3.2-3b-server
    restart: unless-stopped
    ports:
      - "8100:8100"  # Expose vLLM API server on port 8100
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - CUDA_VISIBLE_DEVICES=0
      - HF_TOKEN=${HF_TOKEN}  # Set your Hugging Face token in .env file or export it
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    command: >
      sh -c "
      hf auth login --token ${HF_TOKEN} &&
      hf download meta-llama/Llama-3.2-3B --cache-dir /root/.cache/huggingface &&
      vllm serve meta-llama/Llama-3.2-3B-Instruct
      --max-model-len 65536
      --max-num-batched-tokens 2048 
      --max-num-seqs 1 
      --tensor-parallel-size 1 
      --gpu-memory-utilization 0.3
      --enable-prefix-caching 
      --enable-chunked-prefill 
      --host 0.0.0.0 
      --trust-remote-code 
      --enable-auto-tool-choice
      --tool-call-parser llama3_json
      --disable-fastapi-docs 
      --download-dir /data/models/huggingface 
      --port 8100
      "
    volumes:
      - huggingface_cache:/root/.cache/huggingface  # Cache models locally
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # reachy-hearing:
  #   image: reachy-hearing-thor:r38.2.arm64-sbsa-cu130-24.04
  #   container_name: reachy-hearing-service
  #   restart: unless-stopped
  #   privileged: true  # Required for audio device access
  #   devices:
  #     - /dev/snd:/dev/snd  # Audio devices
  #   volumes:
  #     - ./hearing_app:/app
  #     - /tmp/reachy_sockets:/tmp/reachy_sockets  # Shared socket directory
  #     - /dev/shm:/dev/shm  # Shared memory for audio buffers
  #   working_dir: /app
  #   environment:
  #     - PULSE_SERVER=unix:/run/user/1000/pulse/native  # Optional: PulseAudio
  #   command: bash
  #   stdin_open: true
  #   tty: true
  #   healthcheck:
  #     test: ["CMD", "test", "-S", "/tmp/reachy_sockets/hearing.sock"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 3
  #     start_period: 5s

volumes:
  huggingface_cache:
    driver: local
